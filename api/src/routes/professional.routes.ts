import { Router } from 'express';\nimport { authenticate } from '../auth/middleware/authenticate';\nimport { authorize } from '../auth/middleware/authorize';\nimport { validateRequest } from '../middleware/validateRequest';\nimport { z } from 'zod';\nimport { dashboardService } from '../services/professional/dashboard.service';\nimport { metricsService } from '../services/professional/metrics.service';\nimport { analyticsService } from '../services/professional/analytics.service';\nimport { exportService } from '../services/professional/export.service';\n\nconst router = Router();\n\n// Apply authentication to all professional routes\nrouter.use(authenticate);\nrouter.use(authorize(['admin', 'professional']));\n\n// Dashboard Routes\nconst dashboardConfigSchema = z.object({\n  title: z.string().min(1).max(100),\n  description: z.string().optional(),\n  settings: z.object({\n    theme: z.enum(['light', 'dark', 'auto']),\n    autoRefresh: z.boolean(),\n    refreshInterval: z.number().min(5).max(300),\n    showGrid: z.boolean(),\n    allowCustomization: z.boolean(),\n    compactMode: z.boolean(),\n  }),\n});\n\nconst widgetConfigSchema = z.object({\n  type: z.enum(['metric-card', 'chart', 'table', 'list', 'progress', 'alert', 'calendar', 'activity-feed', 'quick-actions', 'custom']),\n  title: z.string().min(1).max(100),\n  description: z.string().optional(),\n  size: z.enum(['small', 'medium', 'large', 'extra-large']),\n  position: z.object({\n    x: z.number().min(0),\n    y: z.number().min(0),\n    w: z.number().min(1).max(12),\n    h: z.number().min(1).max(12),\n  }),\n  config: z.object({\n    showHeader: z.boolean().optional(),\n    showFooter: z.boolean().optional(),\n    allowResize: z.boolean().optional(),\n    allowMove: z.boolean().optional(),\n    allowRemove: z.boolean().optional(),\n  }).optional(),\n});\n\nconst layoutSchema = z.object({\n  name: z.string().min(1).max(100),\n  description: z.string().optional(),\n  widgets: z.array(widgetConfigSchema),\n});\n\n// GET /api/professional/dashboard/config\nrouter.get('/dashboard/config', async (req, res) => {\n  try {\n    const config = await dashboardService.getDashboardConfig(req.user.tenantId, req.user.id);\n    res.json(config);\n  } catch (error) {\n    console.error('Error fetching dashboard config:', error);\n    res.status(500).json({ error: 'Failed to fetch dashboard configuration' });\n  }\n});\n\n// PUT /api/professional/dashboard/config\nrouter.put('/dashboard/config', validateRequest(dashboardConfigSchema), async (req, res) => {\n  try {\n    const config = await dashboardService.updateDashboardConfig(\n      req.user.tenantId,\n      req.user.id,\n      req.body\n    );\n    res.json(config);\n  } catch (error) {\n    console.error('Error updating dashboard config:', error);\n    res.status(500).json({ error: 'Failed to update dashboard configuration' });\n  }\n});\n\n// GET /api/professional/dashboard/layouts\nrouter.get('/dashboard/layouts', async (req, res) => {\n  try {\n    const layouts = await dashboardService.getDashboardLayouts(req.user.tenantId, req.user.id);\n    res.json(layouts);\n  } catch (error) {\n    console.error('Error fetching dashboard layouts:', error);\n    res.status(500).json({ error: 'Failed to fetch dashboard layouts' });\n  }\n});\n\n// POST /api/professional/dashboard/layouts\nrouter.post('/dashboard/layouts', validateRequest(layoutSchema), async (req, res) => {\n  try {\n    const layout = await dashboardService.createDashboardLayout(\n      req.user.tenantId,\n      req.user.id,\n      req.body\n    );\n    res.status(201).json(layout);\n  } catch (error) {\n    console.error('Error creating dashboard layout:', error);\n    res.status(500).json({ error: 'Failed to create dashboard layout' });\n  }\n});\n\n// PUT /api/professional/dashboard/layouts/:layoutId\nrouter.put('/dashboard/layouts/:layoutId', validateRequest(layoutSchema), async (req, res) => {\n  try {\n    const layout = await dashboardService.updateDashboardLayout(\n      req.user.tenantId,\n      req.user.id,\n      req.params.layoutId,\n      req.body\n    );\n    res.json(layout);\n  } catch (error) {\n    console.error('Error updating dashboard layout:', error);\n    res.status(500).json({ error: 'Failed to update dashboard layout' });\n  }\n});\n\n// DELETE /api/professional/dashboard/layouts/:layoutId\nrouter.delete('/dashboard/layouts/:layoutId', async (req, res) => {\n  try {\n    await dashboardService.deleteDashboardLayout(\n      req.user.tenantId,\n      req.user.id,\n      req.params.layoutId\n    );\n    res.status(204).send();\n  } catch (error) {\n    console.error('Error deleting dashboard layout:', error);\n    res.status(500).json({ error: 'Failed to delete dashboard layout' });\n  }\n});\n\n// GET /api/professional/dashboard/data\nrouter.get('/dashboard/data', async (req, res) => {\n  try {\n    const { widgetIds, timeRange = '30d' } = req.query;\n    const data = await dashboardService.getDashboardData(\n      req.user.tenantId,\n      widgetIds ? (widgetIds as string).split(',') : undefined,\n      timeRange as string\n    );\n    res.json(data);\n  } catch (error) {\n    console.error('Error fetching dashboard data:', error);\n    res.status(500).json({ error: 'Failed to fetch dashboard data' });\n  }\n});\n\n// Metrics Routes\nconst metricsQuerySchema = z.object({\n  timeRange: z.enum(['7d', '30d', '90d', '1y']).optional(),\n  categories: z.string().optional(),\n  includeAlerts: z.boolean().optional(),\n});\n\n// GET /api/professional/metrics/compliance\nrouter.get('/metrics/compliance', validateRequest(metricsQuerySchema, 'query'), async (req, res) => {\n  try {\n    const { timeRange = '30d', categories, includeAlerts = true } = req.query;\n    const metrics = await metricsService.getComplianceMetrics(\n      req.user.tenantId,\n      {\n        timeRange: timeRange as string,\n        categories: categories ? (categories as string).split(',') : undefined,\n        includeAlerts: includeAlerts as boolean,\n      }\n    );\n    res.json(metrics);\n  } catch (error) {\n    console.error('Error fetching compliance metrics:', error);\n    res.status(500).json({ error: 'Failed to fetch compliance metrics' });\n  }\n});\n\n// GET /api/professional/metrics/kpis\nrouter.get('/metrics/kpis', async (req, res) => {\n  try {\n    const { timeRange = '30d' } = req.query;\n    const kpis = await metricsService.getKPIs(\n      req.user.tenantId,\n      timeRange as string\n    );\n    res.json(kpis);\n  } catch (error) {\n    console.error('Error fetching KPIs:', error);\n    res.status(500).json({ error: 'Failed to fetch KPIs' });\n  }\n});\n\n// GET /api/professional/metrics/trends\nrouter.get('/metrics/trends', async (req, res) => {\n  try {\n    const { timeRange = '30d', metric } = req.query;\n    const trends = await metricsService.getTrends(\n      req.user.tenantId,\n      timeRange as string,\n      metric as string\n    );\n    res.json(trends);\n  } catch (error) {\n    console.error('Error fetching trends:', error);\n    res.status(500).json({ error: 'Failed to fetch trends' });\n  }\n});\n\n// GET /api/professional/metrics/benchmarks\nrouter.get('/metrics/benchmarks', async (req, res) => {\n  try {\n    const benchmarks = await metricsService.getBenchmarks(req.user.tenantId);\n    res.json(benchmarks);\n  } catch (error) {\n    console.error('Error fetching benchmarks:', error);\n    res.status(500).json({ error: 'Failed to fetch benchmarks' });\n  }\n});\n\n// Analytics Routes\n// GET /api/professional/analytics/policies\nrouter.get('/analytics/policies', async (req, res) => {\n  try {\n    const { timeRange = '30d' } = req.query;\n    const analytics = await analyticsService.getPolicyAnalytics(\n      req.user.tenantId,\n      timeRange as string\n    );\n    res.json(analytics);\n  } catch (error) {\n    console.error('Error fetching policy analytics:', error);\n    res.status(500).json({ error: 'Failed to fetch policy analytics' });\n  }\n});\n\n// GET /api/professional/analytics/consents\nrouter.get('/analytics/consents', async (req, res) => {\n  try {\n    const { timeRange = '30d' } = req.query;\n    const analytics = await analyticsService.getConsentAnalytics(\n      req.user.tenantId,\n      timeRange as string\n    );\n    res.json(analytics);\n  } catch (error) {\n    console.error('Error fetching consent analytics:', error);\n    res.status(500).json({ error: 'Failed to fetch consent analytics' });\n  }\n});\n\n// GET /api/professional/analytics/audit-trail\nrouter.get('/analytics/audit-trail', async (req, res) => {\n  try {\n    const { timeRange = '30d', entityType, entityId } = req.query;\n    const auditTrail = await analyticsService.getAuditTrail(\n      req.user.tenantId,\n      {\n        timeRange: timeRange as string,\n        entityType: entityType as string,\n        entityId: entityId as string,\n      }\n    );\n    res.json(auditTrail);\n  } catch (error) {\n    console.error('Error fetching audit trail:', error);\n    res.status(500).json({ error: 'Failed to fetch audit trail' });\n  }\n});\n\n// Export Routes\nconst exportSchema = z.object({\n  format: z.enum(['pdf', 'excel', 'csv']),\n  type: z.enum(['dashboard', 'metrics', 'report']),\n  timeRange: z.enum(['7d', '30d', '90d', '1y']).optional(),\n  filters: z.record(z.any()).optional(),\n});\n\n// POST /api/professional/export\nrouter.post('/export', validateRequest(exportSchema), async (req, res) => {\n  try {\n    const { format, type, timeRange, filters } = req.body;\n    const exportResult = await exportService.generateExport(\n      req.user.tenantId,\n      req.user.id,\n      {\n        format,\n        type,\n        timeRange,\n        filters,\n      }\n    );\n    \n    res.setHeader('Content-Type', exportResult.mimeType);\n    res.setHeader('Content-Disposition', `attachment; filename=\"${exportResult.filename}\"`);\n    res.send(exportResult.data);\n  } catch (error) {\n    console.error('Error generating export:', error);\n    res.status(500).json({ error: 'Failed to generate export' });\n  }\n});\n\n// Alerts Routes\n// GET /api/professional/alerts\nrouter.get('/alerts', async (req, res) => {\n  try {\n    const { status = 'active', severity, limit = 50 } = req.query;\n    const alerts = await metricsService.getAlerts(\n      req.user.tenantId,\n      {\n        status: status as string,\n        severity: severity as string,\n        limit: parseInt(limit as string),\n      }\n    );\n    res.json(alerts);\n  } catch (error) {\n    console.error('Error fetching alerts:', error);\n    res.status(500).json({ error: 'Failed to fetch alerts' });\n  }\n});\n\n// PUT /api/professional/alerts/:alertId/acknowledge\nrouter.put('/alerts/:alertId/acknowledge', async (req, res) => {\n  try {\n    const alert = await metricsService.acknowledgeAlert(\n      req.user.tenantId,\n      req.params.alertId,\n      req.user.id\n    );\n    res.json(alert);\n  } catch (error) {\n    console.error('Error acknowledging alert:', error);\n    res.status(500).json({ error: 'Failed to acknowledge alert' });\n  }\n});\n\n// PUT /api/professional/alerts/:alertId/resolve\nrouter.put('/alerts/:alertId/resolve', async (req, res) => {\n  try {\n    const { resolution } = req.body;\n    const alert = await metricsService.resolveAlert(\n      req.user.tenantId,\n      req.params.alertId,\n      req.user.id,\n      resolution\n    );\n    res.json(alert);\n  } catch (error) {\n    console.error('Error resolving alert:', error);\n    res.status(500).json({ error: 'Failed to resolve alert' });\n  }\n});\n\n// Health check for professional features\nrouter.get('/health', (req, res) => {\n  res.json({\n    status: 'healthy',\n    timestamp: new Date().toISOString(),\n    features: {\n      dashboard: 'active',\n      metrics: 'active',\n      analytics: 'active',\n      export: 'active',\n      alerts: 'active',\n    },\n  });\n});\n\nexport { router as professionalRoutes };"